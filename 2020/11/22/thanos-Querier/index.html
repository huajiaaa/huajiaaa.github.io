<!DOCTYPE html><html lang="zh_CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title> | 冰箱里有啤酒</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">冰箱里有啤酒</h1><a id="logo" href="/.">冰箱里有啤酒</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 主页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title"></h1><div class="post-meta">Nov 22, 2020</div><div class="post-content"><p>title: ‘Thanos-Querier’<br>date: 2020-11-22 17:50:56<br>tags: 大监控<br>categories: 技术</p>
<p>Thanos Querier 实现了 prometheus HTTP v1 API, 通过 PromQL 查询急群众的数据.</p>
<p>简而言之，它通过 store api 收集所需的数据, 计算查询并返回结果.</p>
<p>Querier 是完全无状态的并且可以水平扩展。</p>
<h1 id="Global-View"><a href="#Global-View" class="headerlink" title="Global View"></a>Global View</h1><p>由于对于 Querier 而言，“后端”是实现了 gRPC StoreAPI 的所有组件，因此我们可以从任意数量的不同存储中聚合数据，例如:</p>
<ul>
<li>Prometheus (see <a href="https://github.com/thanos-io/thanos/blob/master/docs/components/sidecar.md" target="_blank" rel="noopener">Sidecar</a>)</li>
<li>Object Storage (see <a href="https://github.com/thanos-io/thanos/blob/master/docs/components/store.md" target="_blank" rel="noopener">Store Gateway</a>)</li>
<li>Global alerting/recording rules evaluations (see <a href="https://github.com/thanos-io/thanos/blob/master/docs/components/rule.md" target="_blank" rel="noopener">Ruler</a>)</li>
<li>Metrics received from Prometheus remote write streams (see <a href="https://github.com/thanos-io/thanos/blob/master/docs/components/receive.md" target="_blank" rel="noopener">Receiver</a>)</li>
<li>Another Querier (you can stack Queriers on top of each other)</li>
<li>Non-Prometheus systems! <ul>
<li>e.g <a href="https://github.com/thanos-io/thanos/blob/master/docs/integrations.md#opentsdb" target="_blank" rel="noopener">OpenTSDB</a></li>
</ul>
</li>
</ul>
<h1 id="Run-time-deduplication-of-HA-groups"><a href="#Run-time-deduplication-of-HA-groups" class="headerlink" title="Run-time deduplication of HA groups"></a>Run-time deduplication of HA groups</h1><p>Prometheus 是有状态的, 不允许复制其数据库. 这意味着通过运行多个 Prometheus 副本来提高高可用性不是很容易使用. Thanos Querier 从多个副本中提取数据, 并对这些数据进行重复数据删除、填补空白, 而这一切对于消费者是透明的. </p>
<h1 id="Metric-数据查询时的流程"><a href="#Metric-数据查询时的流程" class="headerlink" title="Metric 数据查询时的流程"></a>Metric 数据查询时的流程</h1><p><img src="https://raw.githubusercontent.com/thanos-io/thanos/master/docs/img/querier.svg" alt="查询流程图"></p>
<p>上图展示了 Querier 对每个 Prometheus 查询请求执行的操作. </p>
<p>有关如何将 Querier 与所需的 StoreAPI 连接的信息, 可参见<a href="https://github.com/thanos-io/thanos/blob/master/docs/service-discovery.md" target="_blank" rel="noopener">此处</a>.</p>
<h3 id="数据去重"><a href="#数据去重" class="headerlink" title="数据去重"></a>数据去重</h3><p>查询层可以对从多个副本收集的 series 进行重复数据删除. 通过为副本设置标签, 然后在启动时将其传递给查询节点来实现.</p>
<h2 id="Query-API"><a href="#Query-API" class="headerlink" title="Query API"></a>Query API</h2><p>Thanos 的 QueryAPI 与 Prometheus 2.x 兼容, 对于 Prometheus 之上的其他功能, Thanos 添加了:</p>
<ul>
<li>部分响应行为(partial response behaviour)</li>
<li>一些额外的参数</li>
<li>自定义响应字段</li>
</ul>
<h3 id="partial-response-behaviour"><a href="#partial-response-behaviour" class="headerlink" title="partial response behaviour"></a>partial response behaviour</h3><p>QueryAPI 和 StoreAPI 通过 PartialResponseStrategy 查询参数来控制准确性和可用性的折中.</p>
<p>在对 QueryAPI 或 StoreAPI 的查询中, 部分响应并不意味着丢失了数据：如果其中一个 StoreAPI 返回错误或超时，而另两个返回成功, 如果损坏的 StoreAPI 没有任何查询内容, 则实际上可以获取正确的数据.</p>
<p>Querier 允许配置不同的超时:</p>
<ul>
<li><code>--query.timeout</code></li>
<li><code>--store.response-timeout</code></li>
</ul>
<p>如果更喜欢可用性而不是准确性, 则可以为底层 StoreAPI 设置比整体查询超时更严格的超时. </p>
<p>### </p>
</div><div class="tags"></div><div class="post-nav"><a class="next" href="/2020/11/22/thanos/">Thanos</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '9068028cdf34808763a3',
  clientSecret: '6a7ac29d31bad8013d5348db4292442adfc4c097',
  repo: 'issues',
  owner: 'huajiaaa',
  admin: ['huajiaaa'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"><input type="hidden" name="si" value="http://yoursite.com"><input name="tn" type="hidden" value="bds"><input name="cl" type="hidden" value="3"><input name="ct" type="hidden" value="2097152"><input name="s" type="hidden" value="on"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/大监控/" style="font-size: 15px;">大监控</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>